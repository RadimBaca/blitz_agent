{% extends "base.html" %}

{% block title %}Database Administration - Blitz Dashboard{% endblock %}

{% block page_header %}Database Administration{% endblock %}

{% block load_form %}
<!-- No load form needed for administration page -->
{% endblock %}

{% block content %}

            <div class="admin-section">
                <h3>Add New Database Connection</h3>
                <form method="POST" action="/add_database" class="db-form">
                    <input type="hidden" name="current_proc" value="{{ proc_name }}">

                    <div class="form-group">
                        <label for="db_name">Database Name:</label>
                        <input type="text" id="db_name" name="db_name" required
                               placeholder="Enter database name" value="{{ test_form.db_name if test_form else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="db_host">Host:</label>
                        <input type="text" id="db_host" name="db_host" required
                               placeholder="localhost or IP address" value="{{ test_form.db_host if test_form else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="db_port">Port:</label>
                        <input type="number" id="db_port" name="db_port" value="{{ test_form.db_port if test_form else 1433 }}"
                               min="1" max="65535" required>
                    </div>

                    <div class="form-group">
                        <label for="db_user">Username:</label>
                        <input type="text" id="db_user" name="db_user" required
                               placeholder="Database username" value="{{ test_form.db_user if test_form else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="db_password">Password:</label>
                        <input type="password" id="db_password" name="db_password" required
                               placeholder="Database password" value="{{ test_form.db_password if test_form else '' }}">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Add Connection</button>
                        <button type="submit" class="btn-secondary" formaction="/test_database" formmethod="post">Test Connection</button>
                        <a href="/{{ proc_name }}" class="btn-tertiary">Cancel</a>
                    </div>
                </form>
            </div>

            <div class="admin-section">
                <h3>Existing Connections</h3>
                {% if connections %}
                    <table class="connections-table">
                        <thead>
                            <tr>
                                <th>Database Name</th>
                                <th>Host</th>
                                <th>Port</th>
                                <th>Username</th>
                                <th>Version</th>
                                <th>Instance Memory (MB)</th>
                                <th>Blitz Procedures</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conn in connections %}
                                <tr {% if conn.db_id == actual_db_id %}class="active-connection"{% endif %}>
                                    <td>{{ conn.db_name }}</td>
                                    <td>{{ conn.db_host }}</td>
                                    <td>{{ conn.db_port }}</td>
                                    <td>{{ conn.db_user }}</td>
                                    <td>{{ conn.version or '-' }}</td>
                                    <td>{{ conn.instance_memory_mb if conn.instance_memory_mb is not none else '-' }}</td>
                                    <td>
                                        {% if conn.has_blitz_procedures is not none %}
                                            {% if conn.has_blitz_procedures %}
                                                <span style="color: green; font-weight: bold;">Yes</span>
                                            {% else %}
                                                <span style="color: red; font-weight: bold;">No</span>
                                            {% endif %}
                                        {% else %}
                                            <span style="color: gray;">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="button-group">
                                            <button type="button" class="btn-copy" onclick="copyConnection('{{ conn.db_name }}', '{{ conn.db_host }}', '{{ conn.db_port }}', '{{ conn.db_user }}', '{{ conn.db_password }}')" title="Copy connection details to form">
                                                Copy
                                            </button>

                                            {% if not conn.has_blitz_procedures %}
                                            <form method="POST" action="/install_blitz_procedures" style="display: inline;"
                                                  onsubmit="return confirm('This will download and install Blitz procedures from the First Responder Kit. Continue?')">
                                                <input type="hidden" name="db_id" value="{{ conn.db_id }}">
                                                <button type="submit" class="btn-secondary" title="Download and install Blitz procedures">
                                                    Install Blitz
                                                </button>
                                            </form>
                                            {% endif %}

                                            <form method="POST" action="/delete_database" style="display: inline;"
                                                  onsubmit="return confirm('Are you sure you want to delete this connection? This will also clear all associated data.')">
                                                <input type="hidden" name="current_proc" value="{{ proc_name }}">
                                                <input type="hidden" name="db_id" value="{{ conn.db_id }}">
                                                <button type="submit" class="btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No database connections found. Add one above to get started.</p>
                {% endif %}
            </div>
{% endblock %}

{% block script %}
<script>
    // Override the default handleDatabaseSelection for administration page
    function handleDatabaseSelection(select) {
        if (select.value === 'add_new') {
            // Reset to current selection and stay on administration page
            select.value = '{{ actual_db_id }}';
            return false; // Don't submit the form
        } else {
            // Submit the form normally for database changes
            select.form.submit();
        }
    }

    // Copy connection details to the form
    function copyConnection(dbName, dbHost, dbPort, dbUser, dbPassword) {
        // Fill the form fields with the copied data
        document.getElementById('db_name').value = dbName + '_copy';
        document.getElementById('db_host').value = dbHost;
        document.getElementById('db_port').value = dbPort;
        document.getElementById('db_user').value = dbUser;
        document.getElementById('db_password').value = dbPassword;

        // Scroll to the form
        document.querySelector('.admin-section').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        // Focus on the database name field for editing
        document.getElementById('db_name').focus();
        document.getElementById('db_name').select();
    }
</script>
{% endblock %}
